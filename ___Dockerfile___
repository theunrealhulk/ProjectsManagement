# Use the official MySQL Docker image
FROM mysql

# Stage 1: Build the Angular frontend
FROM node:16 AS frontend
WORKDIR /app

# Copy the Angular project files
COPY AngularApp/package.json .
COPY AngularApp/package-lock.json .
RUN npm install

# Copy the rest of the Angular project
COPY AngularApp .

# Build the Angular app
RUN npm run start

# Stage 2: Build and run the .NET API
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS backend
WORKDIR /src


# Copy the solution and restore dependencies
COPY ProjectsManager.sln .
COPY ProjectsManager/ProjectsManager.csproj ProjectsManager/
RUN dotnet dev-certs https
RUN dotnet nuget locals all --clear
RUN dotnet restore

# Copy the project files
COPY ProjectsManager ProjectsManager/
WORKDIR /src/ProjectsManager

# Copy the updated appsettings.json
COPY ProjectsManager/appsettings.json .

# Set the ASP.NET Core environment variable to Development
ENV ASPNETCORE_ENVIRONMENT=Development

# Expose the ports (adjust as per your application's requirements)
EXPOSE 80
EXPOSE 443

# Copy the entrypoint script
COPY entrypoint.sh .
RUN chmod +x entrypoint.sh

# Run the entrypoint script
ENTRYPOINT ["./entrypoint.sh"]
